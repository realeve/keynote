## 开发 Runner 遇到的问题

> [李名凯](https://github.com/lmk123)

----

我最近用 [Vue.js](http://vuejs.org/) 写了一个小程序，叫 [Runner](https://github.com/lmk123/Runner)，这次我想分享的就是我在开发 Runner 的过程中碰到的一些问题及解决方案。

----

不知道大家有没有听说过《13 周跑步行走计划》。《13 周跑步行走计划》是一个跑步与行走结合的训练，比如“跑步 1 分钟，行走 2分钟，重复 8 次”。在执行这个计划的时候需要经常看时间，计算一下自己进行到哪一步了。我在这个过程中经常会算错，而且因为要记着这些数字所以不能专心跑步，所以就开发了 Runner 帮我记录训练进度。

----

为了让 Runner 看起来像一个 iOS 应用，我使用了 [Framework7](http://framework7.io/) 作为 UI 框架。为了使用 Framework7 里的导航栏、内容块等，我经常需要在 Framework7 的文档里复制大段大段的 HTML 片段，等到开发的差不多的时候，我觉得密密麻麻的 HTML 片段看起来很不清爽， 而且很难找到夹杂在里面的 Vue.js 的代码，所以用 Vue.js 开发了一个 Framework7 的组件库——[vue-framework7](https://github.com/lmk123/vue-framework7)，然后将原本的 HTML 片段都替换成了这些组件，代码看上去是清爽多了，然后就出现问题了。

----

### 第一个问题：confirm 框无法显示

vue-framework7 里面有一个叫 f7-modal 的组件，用来弹出 iOS 风格的 alert 框、confirm 框，在点击“确定”按钮之后就会消失，但放到 Runner 里面就弹不出来了。

----

为了消除手机端 300 毫秒的点击延迟，我在 Runner 里使用了 `v-touch:tap` 替代 `@click`，我猜想这个问题可能跟 [vue-touch](https://github.com/vuejs/vue-touch) 有关。因为 vue-touch 是对 Hammer.js 的一个封装，所以我去查看了一下 Hammer.js 的文档，发现在 tap 事件之后，还会接着触发一次 click 事件，而我点击“开始训练”的按钮的位置正好就在 confirm 框的“确定”按钮上面，所以这个 click 事件正好触发在了还没显示出来的“确定”按钮上，confrim 框立刻就消失了——整个过程看起来就像 confirm 框从来没有弹出来一样。

----

最后，我把“确定”按钮上的 `@click` 也替换成了 `v-touch:tap` 之后，confirm 框就能正常显示出来了。

----

### 第二个问题：父组件与子组件间的通讯被中断

在点击“开始训练”之后就会进入训练步骤：跑前热身、跑步、跑后热身。每个步骤的计时器都由各自的子组件设定，但训练的标题都显示在父组件 running.vue 里。也就是说，我需要在子组件里修改父组件的状态。

----

最简单的办法就是使用 `this.$parent` 来引用父组件了。但是在使用 vue-framework7 之后，子组件的父组件不再是 running.vue 了，而是 vue-framework7 的组件，这就导致 running.vue 里没法显示训练标题了。

----

这时大家可能会想到用事件的方式传递数据，但我考虑到，如果是在一个比较大型的应用里，多个组件之间需要共用一部分状态，用事件的方式传递数据是远远不够的，而且会让代码逻辑显得混乱，所以这个时候我使用了 [Vuex](https://github.com/vuejs/vuex).

----

Vuex 是 Vue.js 的状态管理架构，用来集中管理组件之间共享的状态。

----

在 Runner 中，有两部分被共享的状态：第一部分就是用户已经进行到了 13 周计划中的第几周、第几课，下次用户打开 Runner 时，要根据当前进度计算出下一次训练的内容；第二部分就是前面提到的,当用户在进行训练时，训练标题和内容就需要在多个组件间共享。如果把这两部分互不相干的状态放在同一个对象里，很容易产生混淆，好在 Vuex 能给状态分类，不同类别的状态相互之间不受干扰。

----

Vuex 同时还支持中间件，每次在操作状态时，中间件都会得到通知，我们就可以在中间件里做些数据持久化、或是打印调试信息之类的事情。Runner 在中间件里将训练进度保存在 localStorage 里，这样用户下次打开 Runner 时就能看到自己已经进行到 13 周计划的哪一步了，而不是重头开始。

----

### 第三个问题：手机屏幕关闭后计时被中断

最后还有一个很头疼的问题。如果用户在使用 Runner 时切换到了其他 APP 或者锁屏了，那么计时就会停止。

----

准确点说，一旦浏览器变为在后台运行，那么浏览器就会停止运行 Javascript，就好像被一个看不见的 `window.alert()` 阻塞了一样。要修正计时数字只需要比对一下显示前和显示后的时间差就可以了，但我想要的效果是在指定的时间点(例如第 55 秒时)提醒用户训练就快结束了，一旦计时停止，那么计时器在屏幕重新被打开之前都不会到达第 55 秒，用户也就收不到提醒了。

----

我谷歌了很长时间也没能找到一个办法让计时器在后台也能运行，倒是无意间发现一个[黑科技](https://github.com/richtr/NoSleep.js)能让屏幕不会自动关闭，但在 Runner 里试了很多次也没法成功。如果大家有什么好的解决方案一定要告诉我。

我今天要分享的内容就是这些了，谢谢大家。
